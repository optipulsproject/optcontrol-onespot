%!TeX root = ./manuscript-numapde-preprint.tex

\section{Introduction}
\label{sec:introduction}

\begin{itemize}
	\item Pulsed laser welding of aluminium alloys of the 2XXX, 5XXX and 6XXX series is a challenging engineering problem due to a hight tendency of the material to hot cracking during the solidification phase. Especially high cooling rates which take place in pulsed laser welding lead to high material strain [cite PAMM-4].
	\item In this paper we propose an optimal control approach to avoid the appearance of the hot cracks.
	\item In order to obtain a realistic model we need to take into account several physical effects which are usually not present in a standard heat dissipation problem: the enthalpy of fusion and the convective heat transfer.
	\item In pulsed laser welding a welding seam consists of multiple partially overlapping welding spots made by switching the laser on and off. Various experiments show that a hot-crack in the first welding spot usually spreads to the whole welding seam. And vice versa, if the first welding spot has no cracks then most likely the whole seam will be crack-free provided the welding regime kept the same for each of the spots [citation needed]. Therefore, in this paper study an optipal control problem for a single welding spot.
	\item (We neglect the evaporation of the metal.)
	\item In particular, we take some effort to define realistic boundary conditions.
	\item From the mathematical point of view it makes a quasi-linear heat equation.
	\item The analysis of associated optimal control problems is quite involved, therefore our focus here is on modelling of the state equation and formulating of an appropriate cost function as well as the numerical solution of the discretized version of the optimal control problem.
	\item This paper is structured as follows \ldots
\end{itemize}


\section{Modelling}
\label{sec:modelling}

The aim of this section is to derive step-by-step a mathematical model for a single spot pulsed laser welding of aluminium alloys of the 2XXX, 5XXX and 6XXX series in a cylinder.

\begin{figure}[ht]
	\centering
	\input{plots/cylinder}
	\caption{Cylinder $\Omega$ and its boundaries.}
	\label{fig:cylinder}
\end{figure}

Let $\Omega	\subset \R^3$ be an open right circular cylinder and $\Gamma = \cup_{i=1}^4 \Gamma_i$ be its boundary surface (see. Figure~\ref{fig:cylinder}), and $\Gamma_1$ be the part of the boundary affected by the laser beam radiation.
Denote by $\theta(x,t)$ the temperature at the point $x \in \Omega$ at the time moment $t \in [0,T]$.

We are going to describe the temperature evolution inside $\Omega$, and hence the evolution of the welding process, as a solution to a boundary value problem based on the heat equation.
The applied nature of the problem provides a few modelling challenges such as temperature dependent properties of the material, a phase transition, and a combination of multiple heat transfer mechanisms.
These challenges are sequentially managed in the succeeding subsections, resulting in a complete model.

% {\color{TolHighContrastBlue}
% Here we are using a sligtly modified mathematical model, which was previously developed in \cite{BergmannBieleninHerzogHildebrandRiedelSchrickerTrunkWorthmann:2017:1}.
% The key differences are:
% \begin{enumerate}
% 	\item The heat capacity function $c(\theta)$ now includes the melting enthalpy, which was missing in the previous paper.
% 	\item The temperature-dependent coefficients $c(\theta)$, $\rho(\theta)$, and $\kappa(\theta)$ are now constructed more accurate using spline fitting to the measured data.
% 	\item The velocity component of the objective functional now takes into consideration all the internal points of the solidification corridor, not only the top surface as in the previous paper.
% 	\item The boundary condition on the laser spot has been modified.
% 	\item The thermal conductivity coefficient $\kappa(\theta)$ (prev. $\lambda(\theta)$) is a matrix-valued function in this paper.
% \end{enumerate}
% }


\subsection{Enthalpy of Fusion and Volumetric Effective Heat Capacity}
\label{subsec:capacity}

Unlike standard heat dissipation problems when the considered material remains in the same state of matter, i.e. its physical properties remain essentially uniform, we deal with a phase transition both during heating up and cooling down stages. The phase transition is accompanied by an absorbation or a release of energy. The required amount of additional energy needed to be provided to a specific quantity of the substance to change its state from a solid to a liquid (at constant pressure) is called \emph{the enthaply of fusion} or \emph{(latent) heat of fusion}. For the opposite a liquid to a solid transition the \emph{heat of solidification} has the same absolute value but its sign is the opposite.

The classical Stefan problem [citation needed] is a particular kind of a boundary value problem, which describes the evolution of a moving boundary between two phases of a material undergoing a phase change. In addition to the underlying heat equation, initial and boundary conditions, the \emph{Stefan condition} is required to provide the energy balance on the phase transition interface.

However, in the present paper we use another approach to integrate the enthalpy of fusion into the boundary value problem. Due to the mixed composition of the aluminium alloys, we have a wide temperature corridor during which the material melts from a solid to a liquid state. The temperature under which the material is fully solid is called \emph{solidus}. Similarly, the temperature above which the material is fully liquid is called \emph{liquidus}. In the current study we consider solidus~=~\SI{858}{\K} and liquidus~=~\SI{923}{K} as the reference values.

Considering the above, it becomes more natural in our case to embed the enthalpy of fusion directly into the heat equation by means of \emph{the heat capacity} coefficient. In a standard heat dissipation problem with no phase transition, the heat capacity coefficient $c(\theta)$ is a temperature dependent function such that $\int_{\theta_0}^{\theta_1} c(\theta)\, d\theta$ describes the amount of energy required to heat a unit mass of the material from temperature $\theta_0$ to temperature $\theta_1$. In the presented model we substitute the heat capacity with \emph{the effective heat capacity} denoted by $c_{\text{eff}}(\theta)$. The latter coefficient coincides with $c(\theta)$ outside the solidus-liquidus temperature corridor but has significantly higher values inside, which is done to archieve the same equality: the total amount of energy required to heat a unit mass of the material from temperature $\theta_0$ to temperature $\theta_1$ (including the enthalpy of fusion if applicable on the interval) is given by the integral $\int_{\theta_0}^{\theta_1} c_{\text{eff}}(\theta)\, d\theta$.

Making the problem even more sophisticated, it turns out that \emph{the density} of the material changes depending on the temperature not only slightly (due to the thermal expansion and contraction of a solid material) but also significantly due to the phase transition. However, considering variable volume of the material would significantly increase complexity of the model and even make it impossible to limit ourselves to just one heat equation. In fact both the effective heat capacity $c_\text{eff}(\theta)$ and the density $\rho(\theta)$ are presented in the mathematical model only as their product $s(\theta) = c_\text{eff}(\theta) \rho(\theta)$. Therefore, we ignore volume changes but encount the variable density in order to obtain maximally plausible \emph{effective volumetric heat capacity} coefficient $s(\theta)$.

For the considered aluminium alloys, the reference values of volumetric heat capacity are given in both the solid and the liquid state of matter. These values show a good linear approxibility. Therefore, we construct $s(\theta)$ using the following procedure:
\begin{enumerate}
	\item We make a linear least square approximation to the experimental data independently in the solid and in the liquid state of matter.
	\item Make a $C^1$ cubic spline by filling the liquidus-solidus gap with uniquely defined cubic polynomial.
	\item In the liquidus-solidus corridor add without loss of smoothness a cubic spline which integral over the considered interval is equal to the enthalpy of fusion of the selected alloy.
\end{enumerate}

Since the final formulas are cumbersome (and can be found in the numerical implementation), we limit ourselves here to a plot of the resulting function, see Figure~\ref{fig:coef}.
% \begin{equation}
% \label{eq:vhc}
% 	s(\theta) = \left\{
% 		\begin{array}{ll}
% 			2324405.2778992266 + 557.7960597360886 x & x < \text{solidus},\\
% 			x^3 ..., & \text{solidus} \le x < \text{liquidus},\\
% 			x^3 ..., & \text{liquidus} \le x,
% 		\end{array} \right.
% \end{equation}


\subsection{Effective Thermal Conductivity}
\label{subsec:conductivity}

Convective heat transfer in the liquid phase becomes the next modelling challenge caused by the phase transition. Due to the Marangoni effect [citation needed], once the solidus point is passed, the heat transfer in the melting pool significantly increases in the radial direction and decreases in the axial direction (see Figure~\ref{fig:cylinder} for the coordinate axes).

In order to not include the convection term into the core equation we approximate linearly the thermal conductivity coefficient $\kappa(\theta)$ to the measured values in the solid state, and then extrapolate it (separately for the radial and the axial directions) to the temperatures above the liquidus with experimentally selected constants. The heat transfer in the angular direction is assumed to be zero.

As the result, we have a matrix valued function $\kappa(\theta) = \diag(\kappa_\text{ax}(\theta), \kappa_\text{rad}(\theta), 0)$, which takes diagonal form since the chosen coordinate system coincides with the main directions of the observed thermal conductivity.

% In order to not include the convection term into the core equation we extrapolate in a special way the thermal conductivity coefficient $\kappa(\theta)$ outside its experimentally measured values in the solid state. While heating, once the solidus point is passed, \emph{the effective thermal conductivity} becomes unequal in different directions resulting in a matrix valued function. We distinguish the radial and the axial main directions of the thermal conductivity. The matrix $\kappa(\theta)$ takes diagonal form if the chosen coordinate system coincides with the main directions of the effective thermal conductivity. Therefore, we have $\kappa(\theta) = \diag(\kappa_\text{ax}(\theta), \kappa_\text{rad}(\theta), 0).$ .See Figure~\ref{fig:cylinder}.


{\color{TolHighContrastBlue}
Obtained in this way numerical results have shown a good poximity to the corresponding lab experiments in the eyeball metric.
}

Similarly to $c(\theta)$, we provide a plot of $\kappa_\text{rad}(\theta)$ and $\kappa_\text{ax}(\theta)$, see Figure~\ref{fig:coef}.

\begin{figure}[ht]
	\centering
	\input{plots/vhc.pgf}
	\input{plots/kappa.pgf}
	\caption{Volumetric heat capacity $s(\theta)$ and thermal conductivity $\kappa(\theta)$.}
	\label{fig:coef}
\end{figure}
% TODO: write a makefile for automated rebuild of PGF plots

% In fact, in the part of $\Omega$ which temperature is above the liquidus threshold an additional heat transfer takes place due to convection in the liquid metal. However, consideration of the convective heat transfer would significantly increase the complexity of the model. One of the possible ways to deal with this issue is assuming no convection on the liquid phase, but defining a fake thermal conductivity coefficient $\kappa(\theta)$ instead.


\subsection{Boundary Conditions}

While in some studies the energy radiated by the laser is plugged into the equation as a volumetric energy source and described by its density, in this paper we assume no internal heat sources.
Instead we consider the energy transferred to the body via the laser beam as a heat flux through the part of the boundary $\Gamma_1$:
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = - \eta \cdot \text{pd}_{\max} \cdot u(t).
\end{equation}
Here $\text{pd}_{\max}$ is the power density of the laser beam, i.e. the ration of the the maximal total power to the area of the affected spot, $\eta$ is the the absorbsion coefficient of the material (which is assumed to be constant), and $u(t)$ is the control function taking values from $[0,1]$.

In a similar way, the cooling of the body is described as a heat flux through the whole boundary (except possibly $\Gamma_3$). Notice, that the choice of a boundary condition at $\Gamma_3$ make any essential difference if the radius of $\Omega$ is chosen big enough.
For simplicity we assume zero heat flux through $\Gamma_3$.

We distingush a convective and a radiative cooling heat fluxes modelled as
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = h \cdot (\theta(x,t) - \theta_\text{amb})
\end{equation}
and
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = k \cdot (\theta(x,t)^4 - \theta^4_\text{amb})
\end{equation}
respctively [reference to these models needed].
Here $k = 2.26 \cdot 10^{-9}$ \si{\W\per\m^2\K^4}, $h = 5$ \si{\W\per\m^2}, are the radiative and the convective cooling coefficients respectively, and $P_{\max}$ is the maximal achievable laser power density in \si{\W\per\m^2}, which is known in advance.
The control function $u(t)$ takes values from $[0,1]$ and represents the laser power intensity.

\subsection{Model Equations}
\label{subsec:equations}

Let us summarize the above considerations and gather them together as a formal mathematical model.

We recall that $\Omega\subset \R^3$ is an open right circular cylinder and $\Gamma = \cup_{i=1}^4 \Gamma_i$ be its boundary surface as it is shown on Figure~\ref{fig:cylinder}. The temperature distribution in $\Omega$ is described by the quasi-linear heat equation
\begin{equation} \label{eq:heat_eq}
	s(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial t} = \div (\kappa(\theta(x,t)) \grad\theta(x,t)),
\end{equation}
which temperature-dependent coefficients $s(\theta(x,t)) = c_\text{eff}(\theta(x,t)) \rho(\theta(x,t))$ and $\kappa(\theta(x,t)$ are constructed as $C^1$ cubic splines [reference to the implementation needed].

While the first spot of the welding seam is considered, the initial temperature $\theta(x,0)$ inside $\Omega$ is assumed to be constant and equal to the ambience temperature $\theta_\text{amb}$.
The boundary conditions are
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = \left\{
		\begin{array}{ll}
			k (\theta_\text{amb}^4 - \theta(x,t)^4) + h (\theta_\text{amb} - \theta(x,t)) + P_{\max} u(t), & \text{on}\ \Gamma_1, \\
			k (\theta_\text{amb}^4 - \theta(x,t)^4) + h (\theta_\text{amb} - \theta(x,t)), & \text{on}\ \Gamma_2 \cup \Gamma_4, \\
			0, & \text{on}\ \Gamma_3.
		\end{array} \right.
\end{equation}
Here $k$, $h$, and $P_{\max}$ are known in advance constants; $u(t)$ is the control function taking values from $[0,1]$.

\section{Optimal Control Problem}
\label{sec:objective}

{\color{TolHighContrastBlue}
In this section we are going to construct an objective functional as a sum of independent penalty terms.
}

From the engineering point of view the desired optimal control (i.e. the laser pulse shape) must:
\begin{itemize}
	\item provide sufficient welding penetration;
	\item ensure complete solidification after welding withing preselected time interval;
	\item avoid hot cracking during the solidification stage;
	\item minimize the total energy consumed by the laser.
\end{itemize}

In the following subsections we present and discuss corresponding penalty terms designed to satisfy these requirements.

{\color{TolHighContrastBlue}
I think, one subsection per every penalty term is too much, so I gonna rewrite it in a more compact way.
}

\subsection{Welding Penetration Penalty}



In order to guarantee the successful completion of the welding stage we must ensure that the melting pool has reached a certein predefined depth. At the same time, exceeding of this depth would result in unnecessary increase in time and energy consumption. Therefore, we select a target point $x_{\text{target}}$ on the symmetry axis of $\Omega$ and a threshold temperature $\theta_{\text{threshold}}$. The corresponding term of the objective functional
\begin{equation}
	J_{\text{penetration}} = \frac{\beta_\text{penetration}}{2} \left( \| \theta(x_{\text{target}},\cdot) \|_{L^{\infty}[0,T]} - \theta_{\text{threshold}} \right)^2,
\end{equation}
penalizes the difference between the maximal temperature at $x_{\text{target}}$ and $\theta_{\text{threshold}}$.


\subsection{Solidification Velocity Penalty}
\label{subsec:velocity}

{\color{TolHighContrastBlue}
Maybe this subsection will benefit from a picture (solidification corridor, isolines, velocity directions)?
}

Our main optimization goal is to avoid appearing of the hot cracks during the solidification stage. For this purpose we restrict the maximal velocity of the solidification front by introducing a non-standard penalty term.

Let $I(t)$ be a moving over time isothermal surface in $\Omega$. For a moving point $x(t) \in I(t)$ one can get
\begin{equation} \label{eq:dxt}
	\frac{d}{dt} \theta(x(t),t) = \grad \theta(x(t),t) \cdot x_t(t) + \theta_t(x(t),t) = 0.
\end{equation}
The derivative $x_t(t)$ can be decomposed as
\begin{equation} \label{eq:xt_alpha_beta}
	x_t(t) = \alpha(x(t),t) \cdot \grad \theta(x(t),t) + \beta(x(t),t) \grad \theta(x(t),t)^{\top}
\end{equation}
where $\alpha(x(t),t)$ and $\beta(x(t),t)$ are scalar functions. Notice, that only the component $\alpha(x(t),t) \grad \theta(x(t),t)$ which is orthogonal to the isothermal surface $I(t)$ can be recovered from equation~\eqref{eq:dxt}. Substituting \eqref{eq:xt_alpha_beta} into \eqref{eq:dxt}, one obtains
\begin{equation}
	\alpha(x(t),t) = \frac{\theta_t(x(t),t)}{\norm{\grad \theta(x(t),t)}^2}.
\end{equation}
Therefore, we define \emph{the velocity of an isothermal surface} as
\begin{equation}
	v(x,t) \coloneqq \frac{\theta_t(x,t)}{\norm{\grad \theta(x,t)}}.
\end{equation}

The function $v(x,t)$ takes positive values near the edge of the melting pool while it expands and negative values while it shrinks. We are only interested in restricting negative values within the solidus-liquidus temperature corridor, we propose the following penalty term
\begin{equation}
	J_{\text{velocity}} = \frac{\beta_\text{velocity}}{2} =
	\int_{\Omega \times [0,T]} \max \{ v_{\max} - v(x,t),\ 0 \}^2 \cdot \chi(\theta(x,t))\, dx\,dt
\end{equation}
where $v_{\max}$ is a pre-defined constant and the indicator function $\chi$ is defined as
\begin{equation}
	\chi(\theta) \coloneqq \left\{
		\begin{array}{ll}
			1, & \text{if}\ \text{solidus} \le \theta \le \text{liquidus}, \\
			0, & \text{otherwise}.
		\end{array} \right.
\end{equation}


\subsection{Completeness of Solidification Penalty}

To ensure that the solidification stage is complete at the final time $T$ we penalize the final temperatures $\theta(x, T)$ which are still above the solidus point:
\begin{equation}
	J_{\text{completeness}} =
	\frac{\beta_\text{completeness}}{2} \int_{\Omega} \max\{ \theta(x, T) - \text{solidus},\ 0 \}^2\, d\omega.
\end{equation}

\subsection{Energy Consumption Penalty}

To penalize the energy consumption we use the following penalty term:
\begin{equation}
	J_{\text{control}} =
	\frac{\beta_\text{control}}{2} \norm{u(t)}_{L^2[0,T]}.
\end{equation}



\section{Discretization}
\label{sec:discretization}

\subsection{Reduction to the radially symmetric case}

{\color{TolHighContrastBlue}
\begin{itemize}
	\item We pretend that everything is 3D up to this moment.
	\item Motivate radial symmetry.
	\item State the entire problem including all the equations and terms of the objective in cylindrical coordinates.
\end{itemize}
}

\subsection{Discretization of the forward problem}

{\color{TolHighContrastBlue}
Mention \fenics somewhere here.
}


\subsection{Evaluation of the gradient}

\section{Numerical Results}
\label{sec:numericals}

\appendix

\section{Implementation Details}
\label{sec:implementation}

\section{Reproducing Numerical Results}


\section{TODO}
\begin{itemize}
	\item Subsection~\ref{subsec:capacity}: introduce symbol $c(\theta)$.
	\item Subsections \ref{subsec:capacity}, \ref{subsec:density}, and \ref{subsec:conductivity}: explain how it is technically done.
	\item Subsection \ref{subsec:equations}: organize it as a summary, putting together everything from section~\ref{sec:modelling}.
	\item Subsection~\ref{subsec:velocity}: make a 2D picture illustrating the velocity of a single isoline at a single time moment.
	\item Section~\ref{sec:numericals}: sketch the gradient descent algorithm.
	\item Make a short explanation about 2XXX, 5XXX, and 6XXX aluminium alloys. What is special about them and why are they relevant to this study?
	\item Section~\ref{sec:implementation}: provide code listings with syntax highlight via pygments.
\end{itemize}