%!TeX root = ./manuscript-numapde-preprint.tex

\section{Introduction}
\label{sec:introduction}

\begin{itemize}
	\item Pulsed laser welding of aluminium alloys of the 2XXX, 5XXX and 6XXX series is a challenging engineering problem due to a hight tendency of the material to hot cracking during the solidification phase. Especially high cooling rates which take place in pulsed laser welding lead to high material strain [cite PAMM-4].
	\item In this paper we propose an optimal control approach to avoid the appearance of the hot cracks.
	\item In order to obtain a realistic model we need to take into account several physical effects which are usually not present in a standard heat dissipation problem: the enthalpy of fusion and the convective heat transfer.
	\item In pulsed laser welding a welding seam consists of multiple partially overlapping welding spots made by switching the laser on and off. Various experiments show that a hot-crack in the first welding spot usually spreads to the whole welding seam. And vice versa, if the first welding spot has no cracks then most likely the whole seam will be crack-free provided the welding regime kept the same for each of the spots [citation needed]. Therefore, in this paper study an optipal control problem for a single welding spot.
	\item (We neglect the evaporation of the metal.)
	\item In particular, we take some effort to define realistic boundary conditions.
	\item From the mathematical point of view it makes a quasi-linear heat equation.
	\item The analysis of associated optimal control problems is quite involved, therefore our focus here is on modelling of the state equation and formulating of an appropriate cost function as well as the numerical solution of the discretized version of the optimal control problem.
	\item This paper is structured as follows \ldots
\end{itemize}


\section{Modelling}
\label{sec:modelling}

The aim of this section is to derive step-by-step a mathematical model for a single spot pulsed laser welding of aluminium alloys in a cylinder.

\begin{figure}[ht]
	\centering
	\input{plots/cylinder}
	\caption{Cylinder $\Omega$ and its boundaries.}
	\label{fig:cylinder}
\end{figure}

Let $\Omega	\subset \R^3$ be an open right circular cylinder and $\Gamma = \cup_{i=1}^4 \Gamma_i$ be its boundary surface (see. Figure~\ref{fig:cylinder}), and $\Gamma_1$ be the part of the boundary affected by the laser beam radiation.
Denote by $\theta(x,t)$ the temperature at the point $x \in \Omega$ at the time moment $t \in [0,T]$.

We are going to describe the temperature evolution inside $\Omega$, and hence the evolution of the welding process, as a solution to a boundary value problem based on the heat equation.
The applied nature of the problem provides a few modelling challenges such as temperature dependent properties of the material, a phase transition, and a combination of multiple heat transfer mechanisms.
These challenges are sequentially managed in the succeeding subsections, resulting in a complete model.

% {\color{TolHighContrastBlue}
% Here we are using a sligtly modified mathematical model, which was previously developed in \cite{BergmannBieleninHerzogHildebrandRiedelSchrickerTrunkWorthmann:2017:1}.
% The key differences are:
% \begin{enumerate}
% 	\item The heat capacity function $c(\theta)$ now includes the melting enthalpy, which was missing in the previous paper.
% 	\item The temperature-dependent coefficients $c(\theta)$, $\rho(\theta)$, and $\kappa(\theta)$ are now constructed more accurate using spline fitting to the measured data.
% 	\item The velocity component of the objective functional now takes into consideration all the internal points of the solidification corridor, not only the top surface as in the previous paper.
% 	\item The boundary condition on the laser spot has been modified.
% 	\item The thermal conductivity coefficient $\kappa(\theta)$ (prev. $\lambda(\theta)$) is a matrix-valued function in this paper.
% \end{enumerate}
% }


\subsection{Enthalpy of Fusion and Volumetric Effective Heat Capacity}
\label{subsec:capacity}

Unlike standard heat dissipation problems when the considered material remains in the same state of matter, i.e. its physical properties remain essentially uniform, we deal with a phase transition both during heating up and cooling down stages. The phase transition is accompanied by an absorbation or a release of energy. The required amount of additional energy needed to be provided to a specific quantity of the substance to change its state from a solid to a liquid (at constant pressure) is called \emph{the enthaply of fusion} or \emph{the (latent) heat of fusion}. For the opposite transition from a liquid to a solid state \emph{the heat of solidification} has the same absolute value but its sign is the opposite.

The classical Stefan problem [citation needed] is a particular kind of a boundary value problem, which describes the evolution of a moving boundary between two phases of a material undergoing a phase change. In addition to the underlying heat equation, initial and boundary conditions, the \emph{Stefan condition} is required to provide the energy balance on the phase transition interface.

However, in the present paper we use another approach to integrate the enthalpy of fusion into the boundary value problem. Due to the mixed composition of the aluminium alloys, we have a wide temperature corridor during which the material melts from a solid to a liquid state. The temperature under which the material is fully solid is called \emph{solidus}. Similarly, the temperature above which the material is fully liquid is called \emph{liquidus}. In the current study we consider solidus~=~\SI{858}{\K} and liquidus~=~\SI{923}{K} as the reference values.

Considering the above, it becomes more natural in our case to embed the enthalpy of fusion directly into the heat equation by means of \emph{the heat capacity} coefficient. In a standard heat dissipation problem with no phase transition, the heat capacity coefficient $c(\theta)$ is a temperature dependent function such that $\int_{\theta_0}^{\theta_1} c(\theta)\, d\theta$ describes the amount of energy required to heat a unit mass of the material from temperature $\theta_0$ to temperature $\theta_1$. In the presented model we substitute the heat capacity with \emph{the effective heat capacity} denoted by $c_{\text{eff}}(\theta)$. The latter coefficient coincides with $c(\theta)$ outside the solidus-liquidus temperature corridor but has significantly higher values inside, which is meant to archieve the same equality: the total amount of energy required to heat a unit mass of the material from temperature $\theta_0$ to temperature $\theta_1$ (including the enthalpy of fusion if applicable on the interval) is given by the integral $\int_{\theta_0}^{\theta_1} c_{\text{eff}}(\theta)\, d\theta$.

Making the problem even more sophisticated, it turns out that \emph{the density} of the material changes depending on the temperature not only slightly (due to the thermal expansion and contraction of a solid material) but also significantly due to the phase transition. However, considering variable volume of the material would significantly increase complexity of the model and even make it impossible to limit ourselves to just one heat equation. In fact both the effective heat capacity $c_\text{eff}(\theta)$ and the density $\rho(\theta)$ are presented in the mathematical model only as their product $s(\theta) = c_\text{eff}(\theta) \rho(\theta)$ which we refer to as \emph{the effective volumetric heat capacity}. Therefore, we ignore volume changes but encount the variable density in order to obtain maximally plausible effective volumetric heat capacity coefficient.

For the considered aluminium alloys, the reference values of volumetric heat capacity are given in both the solid and the liquid state of matter. These values show a good linear approxibility within a fixed state of matter. Therefore, we construct $s(\theta)$ using the following procedure:
\begin{enumerate}
	\item We make a linear least square approximation to the experimental data independently in the solid and in the liquid state of matter.
	\item Make a $C^1$ cubic spline by filling the liquidus-solidus gap with the uniquely defined cubic polynomial.
	\item In the liquidus-solidus corridor add without loss of smoothness a cubic spline which integral over the considered interval is equal to the enthalpy of fusion of the selected alloy.
\end{enumerate}

Since the final formulas are cumbersome, we limit ourselves here to a plot of the resulting function, see Figure~\ref{fig:coef}.
% \begin{equation}
% \label{eq:vhc}
% 	s(\theta) = \left\{
% 		\begin{array}{ll}
% 			2324405.2778992266 + 557.7960597360886 x & x < \text{solidus},\\
% 			x^3 ..., & \text{solidus} \le x < \text{liquidus},\\
% 			x^3 ..., & \text{liquidus} \le x,
% 		\end{array} \right.
% \end{equation}


\subsection{Effective Thermal Conductivity}
\label{subsec:conductivity}

Convective heat transfer in the liquid phase becomes the next modelling challenge caused by the phase transition. Due to the Marangoni effect [citation needed], once the solidus point is passed, the heat transfer in the melting pool significantly increases in the radial direction and decreases in the axial direction (see Figure~\ref{fig:cylinder} for the coordinate axes).

In order to not include the convection term into the core equation we approximate linearly the thermal conductivity coefficient $\kappa(\theta)$ to the measured values in the solid state, and then extrapolate it (separately for the radial and the axial directions) to the temperatures above the liquidus with experimentally selected constants. The heat transfer in the angular direction is assumed to be zero.

As the result, we have a matrix valued function $\kappa(\theta) = \diag(\kappa_\text{ax}(\theta), \kappa_\text{rad}(\theta), 0)$, which takes diagonal form since the chosen coordinate system coincides with the main directions of the observed thermal conductivity.

% In order to not include the convection term into the core equation we extrapolate in a special way the thermal conductivity coefficient $\kappa(\theta)$ outside its experimentally measured values in the solid state. While heating, once the solidus point is passed, \emph{the effective thermal conductivity} becomes unequal in different directions resulting in a matrix valued function. We distinguish the radial and the axial main directions of the thermal conductivity. The matrix $\kappa(\theta)$ takes diagonal form if the chosen coordinate system coincides with the main directions of the effective thermal conductivity. Therefore, we have $\kappa(\theta) = \diag(\kappa_\text{ax}(\theta), \kappa_\text{rad}(\theta), 0).$ .See Figure~\ref{fig:cylinder}.


{\color{TolHighContrastBlue}
Obtained in this way numerical results have shown a good poximity to the corresponding lab experiments in the eyeball metric.
}

The exact algorithm used for constructing coefficients $s(\theta)$ and $\kappa(\theta)$ can be inspected in [link to implementation]. Similarly to $s(\theta)$, we provide a plot of $\kappa_\text{rad}(\theta)$ and $\kappa_\text{ax}(\theta)$, see Figure~\ref{fig:coef}.

\begin{figure}[ht]
	\centering
	\input{plots/vhc.pgf}
	\input{plots/kappa.pgf}
	\caption{Volumetric heat capacity $s(\theta)$ and thermal conductivity $\kappa(\theta)$.}
	\label{fig:coef}
\end{figure}
% TODO: write a makefile for automated rebuild of PGF plots

% In fact, in the part of $\Omega$ which temperature is above the liquidus threshold an additional heat transfer takes place due to convection in the liquid metal. However, consideration of the convective heat transfer would significantly increase the complexity of the model. One of the possible ways to deal with this issue is assuming no convection on the liquid phase, but defining a fake thermal conductivity coefficient $\kappa(\theta)$ instead.


\subsection{Boundary Conditions}

While in some studies the energy radiated by the laser is plugged into the equation as a volumetric energy source and described by its density, in this paper we assume no internal heat sources.
Instead we consider the energy transferred to the body via the laser beam as a heat flux through the part of the boundary $\Gamma_1$:
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = - \eta \cdot \text{pd}_{\max} \cdot u(t).
\end{equation}
Here $\text{pd}_{\max}$ is the power density of the laser beam, $\eta$ is the absorbsion coefficient of the material, and $u(t)$ is the control function bounded by $[0,1]$.
Since the power distribution of the laser beam is close to uniform in the current study, the power density is assumed to be constant (and hence can be evaluated as the ratio of the the maximal total power to the area of the affected spot). The absorbtion coefficient is also assumed to be constant.

In a similar way, the cooling of the body is described as a heat flux through the whole boundary (except possibly $\Gamma_3$). Notice, that the choice of a boundary condition at $\Gamma_3$ make any essential difference if the radius of $\Omega$ is chosen big enough.
For simplicity we assume zero heat flux through $\Gamma_3$.
We distingush a convective and a radiative cooling heat fluxes modelled as
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = h \cdot (\theta(x,t) - \theta_\text{amb})
\end{equation}
and
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = k \cdot (\theta(x,t)^4 - \theta^4_\text{amb})
\end{equation}
respctively [reference to these models needed].
Here $k = 2.26 \cdot 10^{-9}$ \si{\W\per\m^2\K^4}, $h = 5$ \si{\W\per\m^2}, are the radiative and the convective cooling coefficients respectively, and $\theta_\text{amb}$ is the ambience temperature.

\subsection{Model Equations}
\label{subsec:equations}

Let us summarize the above considerations.
We recall that $\Omega\subset \R^3$ is an open right circular cylinder and $\Gamma = \cup_{i=1}^4 \Gamma_i$ be its boundary surface as it is shown on Figure~\ref{fig:cylinder}. The temperature distribution in $\Omega$ is described by the quasi-linear heat equation
\begin{equation} \label{eq:heat_eq}
	s(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial t} = \div (\kappa(\theta(x,t)) \grad\theta(x,t)),
\end{equation}
which temperature-dependent coefficients $s(\theta(x,t)) = c_\text{eff}(\theta(x,t)) \rho(\theta(x,t))$ and $\kappa(\theta(x,t)$ are constructed as $C^1$ cubic splines [reference to the implementation needed].

While the first spot of the welding seam is considered, the initial temperature $\theta(x,0)$ inside $\Omega$ is assumed to be constant and equal to the ambience temperature $\theta_\text{amb}$.
The boundary conditions are
\begin{equation} \label{eq:heat_eq_bc}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} = \left\{
		\begin{array}{ll}
			k (\theta(x,t)^4 - \theta_\text{amb}^4) + h (\theta(x,t) - \theta_\text{amb}) - \eta\, \text{pd}_{\max} u(t), & \text{on}\ \Gamma_1, \\
			k (\theta(x,t)^4 - \theta_\text{amb}^4) + h (\theta(x,t) - \theta_\text{amb}), & \text{on}\ \Gamma_2 \cup \Gamma_4, \\
			0, & \text{on}\ \Gamma_3.
		\end{array} \right.
\end{equation}
% Here $k$, $h$, $\text{pd}_{\max}$, and $\theta_\text{amb}$ are known constants; $u(t)$ is the control function bounded by $[0,1]$.

\section{Optimal Control Problem}
\label{sec:objective}

This section aims at constructing of an objective functional as a sum of independent penalty terms, each term corresponding to a certain application driven requirement.
We are trying to avoid state constraints as far as possible.

As imposed by the application, the desired optimal control must:
\begin{itemize}
	\item provide sufficient welding penetration;
	\item avoid hot cracking during the solidification stage;
	\item ensure complete solidification after welding withing preselected time interval;
	\item minimize the total energy consumed by the laser.
\end{itemize}

In the following subsections we present and discuss corresponding penalty terms designed to satisfy these requirements.


\subsection{Welding Penetration Penalty}
\label{subsec:velocity}

In order to guarantee the \textbf{successful completion of the welding stage} we must ensure that the melting pool has reached a certein predefined depth. At the same time, exceeding of this depth would result in unnecessary increase in time and energy consumption. Therefore, we select a target point $x_{\text{target}}$ on the symmetry axis of $\Omega$ and a threshold temperature $\theta_{\text{threshold}}$. The corresponding term of the objective functional
\begin{equation} \label{eq:J_penetration}
	J_{\text{penetration}} = \frac{\beta_\text{penetration}}{2} \left( \| \theta(x_{\text{target}},\cdot) \|_{L^{\infty}[0,T]} - \theta_{\text{threshold}} \right)^2
\end{equation}
penalizes the difference between the maximal temperature at $x_{\text{target}}$ and $\theta_{\text{threshold}}$. In order to simplify the numerical implementation, we substitute the $L^{\infty}$-norm in~\eqref{eq:J_penetration} with $L^{p}$-norm, where $p$ is sufficiently large.


\subsection{Solidification Velocity Penalty}
\label{subsec:velocity}

Our main practical goal is to \textbf{avoid appearing of the hot cracks} during the solidification stage. For this purpose we restrict the maximal velocity of the solidification front by introducing a non-standard penalty term.

Let $I(t)$ be a moving over time isothermal surface in $\Omega$ (see Figure~\ref{fig:velocity}). For a moving point $x(t) \in I(t)$ one can get
\begin{equation} \label{eq:dxt}
	\frac{d}{dt} \theta(x(t),t) = \grad \theta(x(t),t) \cdot x_t(t) + \theta_t(x(t),t) = 0.
\end{equation}
The derivative $x_t(t)$ can be decomposed as
\begin{equation} \label{eq:xt_alpha_beta}
	x_t(t) = \alpha(x(t),t) \cdot \grad \theta(x(t),t) + \beta(x(t),t) \grad \theta(x(t),t)^{\top}
\end{equation}
where $\alpha(x(t),t)$ and $\beta(x(t),t)$ are scalar functions. Notice, that only the component $\alpha(x(t),t) \grad \theta(x(t),t)$ which is orthogonal to the isothermal surface $I(t)$ can be recovered from equation~\eqref{eq:dxt}. Substituting \eqref{eq:xt_alpha_beta} into \eqref{eq:dxt}, one obtains
\begin{equation}
	\alpha(x(t),t) = \frac{\theta_t(x(t),t)}{\norm{\grad \theta(x(t),t)}^2}.
\end{equation}
Therefore, we define \emph{the velocity of an isothermal surface} as
\begin{equation}
	v(x,t) \coloneqq \frac{\theta_t(x,t)}{\norm{\grad \theta(x,t)}}.
\end{equation}


\begin{figure}
	\centering
	\input{plots/solidification_velocity}
	\caption{Draft: solidification interface and its velocity (sectional view).}
	\label{fig:velocity}
\end{figure}

The function $v(x,t)$ takes positive values near the edge of the melting pool while it expands and negative values while it shrinks. We are only interested in restricting negative values within the solidus-liquidus temperature corridor, we propose the following penalty term
\begin{equation}
	J_{\text{velocity}} = \frac{\beta_\text{velocity}}{2}
	\int_{\Omega \times [0,T]} \max \{ v_{\max} - v(x,t),\ 0 \}^2 \cdot \chi(\theta(x,t))\, dx\,dt
\end{equation}where $v_{\max}$ is a pre-defined constant and the indicator function $\chi$ is defined as
\begin{equation}
	\chi(\theta) \coloneqq \left\{
		\begin{array}{ll}
			1, & \text{if}\ \text{solidus} \le \theta \le \text{liquidus}, \\
			0, & \text{otherwise}.
		\end{array} \right.
\end{equation}


\subsection{Completeness of Solidification and Energy Consumption Penalties}

To ensure that the \textbf{solidification stage is complete} at the final time $T$ we penalize the final temperatures $\theta(x, T)$ which are still above the solidus point:
\begin{equation}
	J_{\text{completeness}} =
	\frac{\beta_\text{completeness}}{2} \int_{\Omega} \max\{ \theta(x, T) - \text{solidus},\ 0 \}^2\, d\omega.
\end{equation}

To \textbf{minimize the energy consumption} we use the following standard penalty term:
\begin{equation}
	J_{\text{control}} =
	\frac{\beta_\text{control}}{2} \norm{u(t)}^2_{L^2[0,T]}.
\end{equation}



\subsection{Optimal Control Problem Formulation}

{\color{TolHighContrastBlue}
We say that a function $u^*(t) \in [0,1]$ is the best optimal control, if it minimizes the objective functional
\begin{equation} \label{eq:J}
	J(u^*, \theta) \coloneqq J_{\text{penetration}} + J_{\text{velocity}} + J_{\text{completeness}} + J_{\text{control}}
\end{equation}
where $\theta(x, t)$ is the unique solution to the boundary value problem \eqref{eq:heat_eq}, \eqref{eq:heat_eq_bc} corresponding to $u^*(t)$.
}


\section{Discretization}
\label{sec:discretization}

\subsection{Weak Formulation}
As the first step we are going to define a weak solution.

\begin{definition}
	Let $V$ be a subspace in $L^2(\Omega \times [0,T])$, $d\Omega$ be a volume element, $dS$ be a surface element, and let
	\begin{equation*}
		\Phi(\theta(x,t)) \coloneqq k (\theta(x,t)^4 - \theta_\text{amb}^4) + h (\theta(x,t) - \theta_\text{amb}).
	\end{equation*}
	We say that $\theta \in L^2(\Omega \times [0,T])$ is \emph{a weak solution} to the boundary value problem \eqref{eq:heat_eq}, \eqref{eq:heat_eq_bc} if the equality
	\begin{multline} \label{eq:weak}
		\int_{\Omega \times [0,T]} s(\theta(x,t)) \frac{\d \theta(x,t)}{\d t} v\, d\Omega\, dt
		+
		\int_{\Omega \times [0,T]} \langle \kappa(\theta(x,t)) \grad\theta(x,t), \grad v \rangle \, d\Omega\, dt \\
		+
		\int_{(\Gamma_1 \cup \Gamma_2) \times [0,T]} \Phi(\theta(x,t)) v\, dS\, dt -
		\int_{\Gamma_1 \times [0,T]} \eta \text{pd}_{\max} u(t) v\, dS\, dt = 0
	\end{multline}
	holds for every $v\in V$.
\end{definition}


\subsection{Reduction to the radially symmetric case}

% Despite the problem is naturally three-dimensional,
Up to this moment the problem was considered in $\R^3$.
However, the power density of the laser beam proved be to radially symmetric, and there was no heat transition in the angular direction observed, i.e. $\partial\Omega/\partial\varphi = 0$. This motivates us to reduce the computational complexity of the problem by reducing the domain $\Omega$ to its two-dimensional radial section $\omega$, see Figure~\ref{fig:sec}.

\begin{figure}
	\centering
	\input{plots/cylinder_sec}
	\input{plots/sec}
	\caption{Draft: reduction to the radially symmetric case.}
	\label{fig:sec}
\end{figure}

Thus, equation~\ref{eq:weak} turns into
\begin{multline} \label{eq:weak_reduced}
	\int_{\omega \times [0,T]} s(\theta(r,z,t)) \frac{\d \theta(r,z,t)}{\d t} v\, r\, dr\, dz\, dt
	+
	\int_{\Omega \times [0,T]} \langle \kappa(\theta(r,z,t)) \grad\theta(r,z,t), \grad v \rangle \, r\, dr\, dz\, dt \\
	+
	\int_{(\gamma_1 \cup \gamma_2) \times [0,T]} \Phi(\theta(x,t)) v\, r\, ds\, dt -
	\int_{\gamma_1 \times [0,T]} \eta \text{pd}_{\max} u(t) v\, r\, ds\, dt = 0.
\end{multline}

Notice, that the gradient operator in equation~\eqref{eq:weak_reduced} must be used in its cylindrical form
\begin{equation*}
	\grad f(r,z,\varphi) =
		\frac{\partial f}{\partial r} e_r
		+
		\frac{\partial f}{\partial z} e_z
		+
		\frac{1}{r} \frac{\partial f}{\partial \varphi} e_{\varphi},
\end{equation*}
however, as mentioned before, due to the radial symmetry of the heat distribution, the $e_{\varphi}$-component vanishes. This feature is convenient for the numerical implementation, since the standard gradient operator (in Cartesian coordinate form) can be used.

Similarly, two penalty terms affected by this reduction take the following forms:
\begin{eqnarray}
	\label{eq:J_velocity_r}
	J_\text{velocity} =
	\frac{\beta_\text{velocity}}{2}
	\int_{\omega \times [0,T]} \max \{ v_{\max} - v(r,z,t),\ 0 \}^2 \cdot \chi(\theta(r,z,t))\, r\, dr\, dz\, dt, \\
	\label{eq:J_completeness_r}
	J_\text{completeness} =
	\frac{\beta_\text{completeness}}{2} \int_{\omega} \max\{ \theta(r,z,T) - \text{solidus},\ 0 \}^2\, r\, dr\, dz.
\end{eqnarray}


\subsection{Discretization of the forward problem}

We are going to combine the finite difference method in time with the finite element method in space.

{\color{TolHighContrastBlue}
Mention \fenics somewhere here.
In order to use \fenics \ldots
}

Let $N_t$ be the number of considered time steps excluding the initial state, then we denote:
\begin{align}
	\tau & \coloneqq T/N_t, \\
	\theta_n(x) & \coloneqq \theta(x,n\tau), & n &= 0, \ldots, N_t, \\
	\theta_{n+\frac{1}{2}} & \coloneqq \alpha\theta_{n+1} + (1-\alpha)\theta_n,
	 & n &= 0, \ldots, N_t-1, \\
	u_n & \coloneqq u(n\tau), & n &= 0, \ldots, N_t-1,
\end{align}
% \end{mdframed}
where $\alpha \in [0,1]$ is the implicitness parameter which is not neccessary equal to $1/2$.


Withing the time interval $(n\tau, n\tau+\tau]$ we define the the following discrete in time operators:
% \begin{mdframed}
\begin{align}
	\frac{\d\theta}{\d t} & \coloneqq \frac{\theta_{n+1}-\theta_n}{\tau},\\
	\grad(\theta) & \coloneqq \grad\left(\theta_{n+\frac{1}{2}}\right),\\
	\Phi(\theta) & \coloneqq \Phi\left(\theta_{n+\frac{1}{2}}\right),\\
	s(\theta) & \coloneqq s(\theta_n),\\
	\kappa(\theta) & \coloneqq \kappa(\theta_n).
\end{align}
% \end{mdframed}

Now equation~\eqref{eq:weak_reduced} takes the form
\begin{multline} \label{eq:discrete}
	\sum_{n=0}^{N_t-1}\int_{\omega}
		s(\theta_n) (\theta_{n+1}-\theta_n) v_n\, r\, dr\, dz
	+ \tau
	\sum_{n=0}^{N_t-1}\int_{\omega}
		\left\langle \kappa(\theta_n) \grad \theta_{n+\frac{1}{2}} , \grad v_n \right\rangle\, r\, dr \, dz \\
	+ \tau
	\sum_{n=0}^{N_t-1}\int_{\gamma_1 \cup \gamma_2}
		\Phi \left( \theta_{n+\frac{1}{2}} \right)  v_n\, r\, ds
	- \tau
	\sum_{n=0}^{N_t-1}\int_{\gamma_1}
		\eta \text{pd}_{\max}\, u_n v_n\, r\, ds = 0.
\end{multline}

In~\eqref{eq:discrete} we treat $\theta_0$ as a known in advance initial temperature field and $[\theta_1, \theta_2, \ldots, \theta_{N_t}]$ as the unknown vector (of scalar fields).

% Mind a little inconsistency in the indexing of $\theta$ and the test function $v = [v_0, v_1, \ldots, v_{N_t-1}]$. This is made on purpose to simplify indexing of arrays in the code.


\subsection{Evaluation of the gradient}

{\color{TolHighContrastBlue}
Write here about automatic differentiation in \fenics.
}

Let the temperature field evolution $\theta$ be already known and $p=[p_0, p_1, \ldots, p_{N_t-1}]$ be the sought-for adjoint state, see Figure~\ref{fig:indexing_diagram}.
The Lagrange function takes the following form
\begin{multline}
	\mathcal{L}(\theta,u,p) \coloneqq
	% \sum_{n=0}^{N_t-1}\int_{\Omega}
	% 	\vel_{\circ}^2(\theta_n,\theta_{n+1}) +
	J(\theta,u)
	+
	\sum_{n=0}^{N_t-1}\int_{\Omega}
		s(\theta_n) (\theta_{n+1}-\theta_n) p_n\, d\omega \\
	+ \tau
	\sum_{n=0}^{N_t-1}\int_{\Omega}
		\left\langle \kappa(\theta_n) \grad \theta_{n+\frac{1}{2}}, \grad p_n \right\rangle\, d\omega \\
	+ \tau
	\sum_{n=0}^{N_t-1}\int_{\gamma_1 \cup \gamma_2}
		\Phi \left( \theta_{n+\frac{1}{2}} \right) p_n\, ds
	- \tau
	\sum_{n=0}^{N_t-1}\int_{\gamma_1}
		\eta \text{pd}_{\max} u_n\, p_n\, ds.
\end{multline}

\section{Numerical Results}
\label{sec:numericals}

\appendix

\section{Implementation Details}
\label{sec:implementation}

\section{Reproducing Numerical Results}


\section{TODO}
\begin{itemize}
	\item Subsection~\ref{subsec:capacity}: introduce symbol $c(\theta)$.
	\item Subsections \ref{subsec:capacity}, \ref{subsec:density}, and \ref{subsec:conductivity}: explain how it is technically done.
	\item Subsection \ref{subsec:equations}: organize it as a summary, putting together everything from section~\ref{sec:modelling}.
	\item Subsection~\ref{subsec:velocity}: make a 2D picture illustrating the velocity of a single isoline at a single time moment.
	\item Section~\ref{sec:numericals}: sketch the gradient descent algorithm.
	\item Make a short explanation about 2XXX, 5XXX, and 6XXX aluminium alloys. What is special about them and why are they relevant to this study?
	\item Section~\ref{sec:implementation}: provide code listings with syntax highlight via pygments.
\end{itemize}