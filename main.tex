%!TeX root = ./manuscript-numapde-preprint.tex
% target journal
% * Optimization and Engineering
% * Engeering Optimization
% * Mathematical and Computer Modelling of Dynamical Systems

\section{Introduction}
\label{sec:introduction}

Pulsed laser welding is a standard technology to merge metal or thermoplastic components.
Its advantages are the narrow spatial concentration and high peak power of the the heat source, as well as the opportunity to quickly and frequently adjust the laser power in time.
These characteristics can be exploited to generate narrow, deep welds at high welding rates.
However, in comparison to continuous wave laser processes, pulse laser welding is reported to have an elevated tendency to produce hot cracks during the solidification phase due to higher cooling and thus strain rates.
This is particularly difficult for the welding of certain aluminum alloys, \eg, of the 2XXX, 5XXX and 6XXX series, which remains a challenging engineering problem \cite{Katayama:2001:1,ZhangWeckmanZhou:2008:1,BieleninBergmann:2017:1}.

Previous analyses have shown the potential to reduce hot cracking by varying the laser power profile in pulsed laser welding; see, \eg, \cite{BieleninBergmann:2017:1,JiaZhangYuShiLiuWuYeWangTian:2021:1}.
In this paper, we propose an optimal control approach to find power profiles which are optimal in a certain sense.
We concentrate on single-spot laser pulse welding problems with a view towards aluminum alloy welding.
Since welding seams consist of multiple, partially overlapping welding spots, this work constitutes as a first step towards the optimization of entire welding seams.

In order to obtain a sufficiently realistic forward model of heat distribution, we need to take into account several physical effects, including temperature dependent heat capacity and thermal conductivity, the enthalpy of fusion and convective heat transfer.
From the mathematical point of view, this results in a quasi-linear heat equation.
Evaporation of metal will be disregarded, as well as fluidic motion inside the weld pool.
The thermal energy incurred through the laser into the welded component is modeled through a heat flux boundary condition.
Our objective or cost functional takes into account, among other things, the speed of solidification in order to avoid or reduce the appearance of the hot cracks.

The emphasis of our contribution lies with the description of the quasilinear heat equation model, the formulation of an appropriate cost function, as well as the numerical solution of a discretized version of the optimal control problem by a projected gradient descent scheme.
The material is structured as follows.
In \cref{sec:modelling}, we discuss the quasilinear heat equation representing the forward model.
The optimal control problem is described in \cref{sec:optimal_control_problem}.
Its discretization is detailed in \cref{sec:discretization}, where we also present a reduction of the three-dimensional setup to the radially symmetric case.
\Cref{sec:numericals} is devoted to the presentation of optimized laser pulse profiles under various conditions.

% \begin{itemize}
	% \item Pulsed laser welding of aluminum alloys of the 2XXX, 5XXX and 6XXX series is a challenging engineering problem due to a hight tendency of the material to hot cracking during the solidification phase. Especially high cooling rates which take place in pulsed laser welding lead to high material strain [cite PAMM-4].
	% \item In this paper we propose an optimal control approach to avoid the appearance of the hot cracks.
	% \item In order to obtain a realistic model we need to take into account several physical effects which are usually not present in a standard heat dissipation problem: the enthalpy of fusion and the convective heat transfer.
	% \item In pulsed laser welding a welding seam consists of multiple partially overlapping welding spots made by switching the laser on and off. Various experiments show that a hot-crack in the first welding spot usually spreads to the whole welding seam. And vice versa, if the first welding spot has no cracks then most likely the whole seam will be crack-free provided the welding regime kept the same for each of the spots [citation needed]. Therefore, in this paper study an optipal control problem for a single welding spot.
	% \item (We neglect the evaporation of the metal.)
	% \item In particular, we take some effort to define realistic boundary conditions.
	% \item From the mathematical point of view it makes a quasi-linear heat equation.
	% \item The analysis of associated optimal control problems is quite involved, therefore our focus here is on modelling of the state equation and formulating of an appropriate cost function as well as the numerical solution of the discretized version of the optimal control problem.
	% \item This paper is structured as follows \ldots
% \end{itemize}


\section{Modelling}
\label{sec:modelling}

\begin{figure}[ht]
	\centering
	\input{plots/tikz/cylinder}
	\caption{Cylinder $\Omega$ and its boundaries.}
	\label{fig:cylinder}
\end{figure}

The aim of this section is to derive step-by-step a mathematical model for a single-spot pulsed laser welding problems of aluminum alloys in a cylindrical domain.
To this end, let $\Omega	\subset \R^3$ be an open, orthogonal circular cylinder and $\Gamma = \cup_{i=1}^4 \Gamma_i$ be its boundary surface (see \cref{fig:cylinder}).
Here $\Gamma_1$ is the portion of the boundary affected by the laser beam radiation.
We denote by $\theta(x,t)$ the temperature at the point $x \in \Omega$ at time $t \in [0,T]$.

We are going to describe the temperature evolution inside $\Omega$, and hence the evolution of the welding process, as a solution to a boundary value problem based on the quasilinear heat equation.
The applied nature of the problem provides a few modelling challenges such as temperature dependent properties of the material, liquid/solid phase transition, and a combination of multiple heat transfer mechanisms.
These challenges are sequentially addressed in the following subsections, resulting in a complete model.

% {\color{TolHighContrastBlue}
% Here we are using a sligtly modified mathematical model, which was previously developed in \cite{BergmannBieleninHerzogHildebrandRiedelSchrickerTrunkWorthmann:2017:1}.
% The key differences are:
% \begin{enumerate}
% 	\item The heat capacity function $c(\theta)$ now includes the melting enthalpy, which was missing in the previous paper.
% 	\item The temperature-dependent coefficients $c(\theta)$, $\rho(\theta)$, and $\kappa(\theta)$ are now constructed more accurate using spline fitting to the measured data.
% 	\item The velocity component of the objective functional now takes into consideration all the internal points of the solidification corridor, not only the top surface as in the previous paper.
% 	\item The boundary condition on the laser spot has been modified.
% 	\item The thermal conductivity coefficient $\kappa(\theta)$ (prev. $\lambda(\theta)$) is a matrix-valued function in this paper.
% \end{enumerate}
% }


\subsection{Enthalpy of Fusion and Volumetric Effective Heat Capacity}
\label{subsec:capacity}

Unlike standard heat dissipation problems when the considered material remains in the same state of matter and its physical properties remain essentially uniform, we deal with a phase transition during the heating and cooling stages. 
These phase transitions are accompanied by an absorption or a release of energy. 
The required amount of additional energy needed to be provided to a specific quantity of the substance to change its state from a solid to a liquid (at constant pressure) is called the \emph{enthalpy of fusion} or the \emph{(latent) heat of fusion}. 
For the opposite transition from a liquid to a solid state \emph{the heat of solidification} has the same absolute value but its sign is the opposite.

These phenomena are often modeled in terms of the classical Stefan problem, which is a particular kind of a boundary value problem describing the evolution of a moving boundary between two phases of a material undergoing a phase change; see for instance \cite{Gupta:2003:1}. 
In addition to the underlying heat equation, initial and boundary conditions, the \emph{Stefan condition} is required to provide the energy balance on the phase transition interface.
However, in the present paper we use another approach to integrate the enthalpy of fusion into the boundary value problem. 
Due to the mixed composition of aluminum alloys, we have a wide temperature corridor (rather than a single melting temperature) within which the material melts from a solid to a liquid state. 
The temperature below which the material is fully solid is called \emph{solidus}. 
Similarly, the temperature above which the material is fully liquid is called \emph{liquidus}. 
In the current study we consider $\text{solidus} = \SI{858}{\K}$ and $\text{liquidus} = \SI{923}{K}$ as reference values.

Considering the above, it becomes more natural in our case to embed the enthalpy of fusion directly into the heat equation by means of \emph{the heat capacity} coefficient. 
In a standard heat dissipation problem with no phase transition, the heat capacity coefficient $c(\theta)$ is a temperature dependent function such that $\int_{\theta_0}^{\theta_1} c(\theta) \, \d\theta$ describes the amount of energy required to heat a unit mass of the material from temperature $\theta_0$ to temperature $\theta_1$. 
In the presented model we substitute the heat capacity with an \emph{effective heat capacity} denoted by $c_{\text{eff}}(\theta)$. 
The latter coefficient coincides with $c(\theta)$ outside the solidus--liquidus temperature corridor but has significantly higher values inside, which is meant to archieve the same equality: the total amount of energy required to heat a unit mass of the material from temperature $\theta_0$ to temperature $\theta_1$ (including the enthalpy of fusion if applicable on the interval) is given by the integral $\int_{\theta_0}^{\theta_1} c_{\text{eff}}(\theta) \, \d\theta$.

Another effect to be taken into account is that the \emph{density}~$\rho$ of aluminum alloys changes significantly over the temperature regime under consideration due to thermal expansion and contraction.
However, considering variable volume of the material would lead to a free boundary problem, which significantly increases the complexity of our model.
We therefore take volume changes into account through a temperature dependent density.
Overall, this leads to an \emph{effective volumetric heat capacity} $s(\theta) = c_\textup{eff}(\theta) \rho(\theta)$ in our heat equation.

For the aluminum alloys under consideration, reference values of volumetric heat capacity are given in both the fully solid and the fully liquid state of matter. 
These values show a good linear approxibility within a fixed state of matter. 
Therefore, we construct $s(\theta)$ using the following procedure:
\begin{enumerate}
	\item 
		We perform a linear least-squares approximation to the experimental data independently in the solid and in the liquid state of matter.
	\item 
		We choose a $C^1$ cubic spline by filling the liquidus--solidus temperature gap with the uniquely defined cubic polynomial.
	\item 
		In the liquidus--solidus interval, we add without loss of smoothness a cubic spline whose integral over the considered interval is equal to the enthalpy of fusion of the selected alloy.
\end{enumerate}
\added[id=RH]{\textbf{Isn't (ii) and (iii) the same spline? Then we should put these into the same item.}}

We do not present the above procedure in terms of cumbersome formulas but limit ourselves here to a plot of the resulting effective volumetric heat capacity function; see \cref{fig:coef}.


\subsection{Effective Thermal Conductivity}
\label{subsec:conductivity}

Convective heat transfer in the liquid phase becomes the next modeling challenge caused by the phase transition. 
Due to the Marangoni effect, see \cite{MillsKeeneBrooksShirali:1998:1,Saldi:2012:1}, once the solidus point is passed, the heat transfer in the melting pool significantly increases in radial direction and decreases in axial direction (see \cref{fig:cylinder} for the coordinate axes).
In order to not include the convection term into the core equation we approximate linearly the thermal conductivity coefficient $\kappa(\theta)$ to its measured values in the solid state, and then extrapolate it (separately for the radial and the axial directions) to the temperatures above the liquidus with experimentally selected constants. 
\added[id=RH]{Convective} heat transfer in the angular direction is assumed to be zero.
As a result, we have a matrix-valued effective thermal conductivity function $\kappa(\theta) = \diag(\kappa_\textup{ax}(\theta), \kappa_\textup{rad}(\theta), 0)$ in diagonal form in a cylindrical coordinate system.

The exact algorithm used for constructing $\kappa(\theta)$ (and also $s(\theta)$) can be inspected in code in \cite[\texttt{optipuls.coefficients}]{optipuls_github}. 
We provide a plot of $\kappa_\textup{rad}(\theta)$ and $\kappa_\textup{ax}(\theta)$; see \cref{fig:coef}.
Numerical simulations based on these assumptions have shown reasonable correspondence to the real experiments, \added[id=DS]{\textbf{citation desirable}}.

\begin{figure}[ht]
	\centering
	\includegraphics{plots/coefficients/vhc.pdf}
	\includegraphics{plots/coefficients/kappa.pdf}
	\caption{Effective volumetric heat capacity $s(\theta)$ and effective thermal conductivity $\kappa(\theta)$ constructed using spline fitting procedure.}
	\label{fig:coef}
\end{figure}


\subsection{Boundary Conditions}
\label{subsec:boundary_conditions}

While some studies considered the energy introduced by the laser as a volumetric energy source, in this paper we use flux boundary conditions on the boundary part $\Gamma_1$ for this purpose:
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} 
	= 
	- \eta \, \text{pd}_{\max} \, u(t)
	.
\end{equation}
Here $\eta$ is the absorption coefficient of the material, $\text{pd}_{\max}$ is the power density of the laser beam, and $u(t)$ is the control function with values in $[0,1]$.
Since the power distribution of the laser beam taken to be uniform across~$\Gamma_1$ in the current study, the power density is assumed to be constant and hence can be evaluated as the ratio of the maximal total power to the area of the affected spot. 
The absorption coefficient~$\eta$ is also assumed to be constant.

The cooling of the body is a result of the heat flux through the entire boundary except $\Gamma_3$; see \cref{fig:cylinder}.
For simplicity we assume zero heat flux through $\Gamma_3$, which is a reasonable approximation when the radius of $\Omega$ is sufficiently large.
On the remaining parts of the boundary, we distingush convective and radiative heat fluxes modelled as
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} 
	= 
	h \cdot (\theta(x,t) - \theta_\textup{amb})
\end{equation}
and
\begin{equation}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} 
	= 
	k \cdot (\theta(x,t)^4 - \theta^4_\textup{amb})
	,
\end{equation}
respectively; see for instance \cite[Chapter~3]{Sluzalec:2005:1}.
Here $k = 2.26 \cdot 10^{-9}$ \si{\W\per\m^2\K^4} and $h = 5$ \si{\W\per\m^2} are the radiative and the convective transfer coefficients, respectively, and $\theta_\textup{amb}$ denotes the ambient temperature.


\subsection{Summary of Model Equations}
\label{subsec:equations}

Let us summarize our model based on the above considerations.
We recall that $\Omega\subset \R^3$ is an open, orthogonal circular cylinder and $\Gamma = \cup_{i=1}^4 \Gamma_i$ is its boundary surface as shown in \cref{fig:cylinder}. 
The temperature distribution in $\Omega$ is governed by the quasi-linear heat equation
\begin{equation} \label{eq:heat_eq}
	s(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial t} 
	= 
	\div \paren[big](){\kappa(\theta(x,t)) \grad\theta(x,t)}
	,
\end{equation}
where the temperature-dependent coefficients $s(\theta(x,t)) = c_\textup{eff}(\theta(x,t)) \rho(\theta(x,t))$ and $\kappa(\theta(x,t)$ are constructed as $C^1$ cubic splines as detailed in \cite[\texttt{optipuls.coefficients}]{optipuls_github}.

Since we consider single-spot welding, the initial temperature $\theta(x,0)$ inside $\Omega$ is assumed to be constant and equal to the ambience temperature $\theta_\textup{amb}$:
\begin{equation} \label{eq:heat_eq_ic}
	\theta(x,0)
	=
	\theta_\textup{amb}
	\quad
	\text{in } \Omega
	.
\end{equation}
The boundary conditions for \eqref{eq:heat_eq} are
\begin{equation} \label{eq:heat_eq_bc}
	\kappa(\theta(x,t)) \frac{\partial \theta(x,t)}{\partial \vn} 
	= 
	\paren[auto]\{\}{%
		\begin{aligned}
			&
			k (\theta(x,t)^4 - \theta_\textup{amb}^4) + h (\theta(x,t) - \theta_\textup{amb}) - \eta\, \text{pd}_{\max} u(t)
			& 
			& 
			\text{on } \Gamma_1
			, 
			\\
			& 
			k (\theta(x,t)^4 - \theta_\textup{amb}^4) + h (\theta(x,t) - \theta_\textup{amb})
			& 
			& 
			\text{on } \Gamma_2 \cup \Gamma_4
			, 
			\\
			& 
			0
			& 
			& 
			\text{on } \Gamma_3
			.
		\end{aligned}
	}
	.
\end{equation}
We recall that $k$, $h$, $\text{pd}_{\max}$ and $\theta_\textup{amb}$ are known constants.
Moreover, $u(t)$ is the control function with values by $[0,1]$ we seek to determine, which represents the fraction of maximal laser power to be emitted as a function of time.


\section{Optimal Control Problem}
\label{sec:optimal_control_problem}

This section aims at constructing of an objective functional as a sum of independent penalty terms, each with a different purpose with relation to the single-splot welding application in mind.
% We are trying to avoid state constraints as far as possible.
As imposed by the application, the desired optimal control representing the emitted laser power profile must:
\begin{enumeratearabic}
	\item 
		provide sufficient welding penetration;
	\item 
		avoid hot cracking during the solidification stage;
	\item 
		ensure complete solidification after welding within the preselected time interval~$[0,T]$;
	\item 
		minimize the total energy consumed by the laser.
\end{enumeratearabic}

In the following subsections we present and discuss four penalty terms designed to target of one these requirements each.
We mention that similar, preliminary ideas were already presented in \cite{BergmannBieleninHerzogHildebrandRiedelSchrickerTrunkWorthmann:2017:1} but with little detail and discussion.


\subsection{Welding Penetration Penalty}
\label{subsec:welding_penetration}

In order to guarantee the \textbf{successful completion of the welding stage} we must ensure that the melting pool has reached a certain predefined depth. 
At the same time, exceeding of this depth would result in an unnecessary increase in energy consumption and the time required for cooling.
Therefore, we select a target point $x_{\text{target}}$ on the symmetry axis of $\Omega$ and a threshold temperature $\theta_{\text{target}}$ and formulate a term which penalizes the difference between the maximal temperature reached at $x_{\text{target}}$ and a target temperature~$\theta_{\text{target}}$:
\begin{equation} \label{eq:J_penetration}
	J_\textup{penetration} 
	= 
	\frac{\beta_\textup{penetration}}{2} \paren[big](){\norm{\theta(x_{\text{target}},\cdot)}_{L^p(0,T)} - \theta_{\text{target}}}^2
	.
\end{equation}
Here $p$ is sufficiently large so that the $L^p$-norm, which is chosen for simplicity and to avoid non-differentiabilities and state constraints, approximates the $L^\infty$-norm.


\subsection{Solidification Velocity Penalty}
\label{subsec:velocity}

Our main practical goal is to \textbf{avoid the appearance of hot cracks} during the solidification stage. 
As mentioned in \cref{sec:introduction}, we associate hot cracks with high velocities of the solidification front.
We therefore seek to restrict the maximal velocity of the solidification front by introducing a non-standard penalty term derived below.

We begin by characterizing the velocity of a point $x(t)$ on some moving isothermal surface in $\Omega$; see \cref{fig:velocity}.
Since the temperature $\theta(x(t),t)$ is constant, we obtain
\begin{equation} \label{eq:dxt}
	\frac{\d}{\d t} \theta(x(t),t) 
	= 
	\grad \theta(x(t),t) \cdot x_t(t) + \theta_t(x(t),t) 
	= 
	0
	.
\end{equation}
The derivative $x_t(t)$ can be decomposed as
\begin{equation} \label{eq:xt_alpha_beta}
	x_t(t) 
	= 
	\alpha(x(t),t) \, \grad \theta(x(t),t) + \text{component perpendicular to } \grad \theta(x(t),t),
\end{equation}
where $\alpha(x(t),t)$ is a scalar function. 
Substituting \eqref{eq:xt_alpha_beta} into \eqref{eq:dxt}, we obtain 
\begin{equation}
	\alpha(x(t),t) 
	= 
	\frac{\added[id=RH]{{}-{}} \theta_t(x(t),t)}{\norm{\grad \theta(x(t),t)}^2}
	,
\end{equation}
where $\norm{\cdot}$ denotes the Euclidean norm.
Therefore, we can define the \emph{velocity of any isothermal surface} passing through the point~$x$ at time~$t$ as
\begin{equation}
	v(x,t) 
	\coloneqq 
	\frac{\added[id=RH]{{}-{}} \theta_t(x,t)}{\norm{\grad \theta(x,t)}}
	.
\end{equation}

\begin{figure}
	\centering
	\input{plots/tikz/solidification_velocity}
	\caption{\added[id=DS]{\textbf{Draft:}} solidification interface and its velocity (sectional view).}
	\label{fig:velocity}
\end{figure}

While the melting pool expands, $v(x,t)$ takes \replaced[id=RH]{negative}{positive} values near the edge of the pool since $\theta_t > 0$ holds.
When the pool shrinks, $v(x,t)$ has \replaced[id=RH]{positive}{negative} values.
We are only interested in restricting \replaced[id=RH]{positive}{negative} velocities and only within the solidus--liquidus temperature corridor.
We therefore propose the following penalty term,
\begin{equation} \label{eq:J_velocity}
	J_\textup{velocity} 
	= 
	\frac{\beta_\textup{velocity}}{2} \int_{\Omega \times (0,T)} \max \paren[big]\{\}{\replaced[id=RH]{v(x,t) - v_{\max}}{v_{\max} - v(x,t)}, \; 0}^2 \cdot \chi(\theta(x,t)) \d x \d t
	,
\end{equation}
\added[id=RH]{\textbf{@DS: The above corrections in the sign of $v(x,t)$ may require an update of the code. The updated formula agrees with the original proposal in \cite{BergmannBieleninHerzogHildebrandRiedelSchrickerTrunkWorthmann:2017:1}.}}
where $v_{\max}$ is a pre-defined constant and the indicator function $\chi$ is defined as
\begin{equation}
	\chi(\theta) 
	\coloneqq 
	\begin{cases}
		1 & \text{if}\ \text{solidus} \le \theta \le \text{liquidus}
		, 
		\\
		0 & \text{otherwise}
		.
	\end{cases}
\end{equation}


\subsection{Completeness of Solidification}

To ensure that the \textbf{solidification stage is complete} at the given final time $T$, we penalize final temperatures $\theta(x,T)$ which are still above the solidus temperature by means of the following term,
\begin{equation} \label{eq:J_completeness}
	J_\textup{completeness} 
	=
	\frac{\beta_\textup{completeness}}{2} \int_{\Omega} \max \paren[big]\{\}{\theta(x, T) - \text{solidus}, \; 0}^2 \d x
	.
\end{equation}


\subsection{Energy Consumption Penalties}

The \textbf{consumption of energy} in the process is taken into account by means of the following standard quadratic control cost term,
\begin{equation}
	J_\textup{control} 
	=
	\frac{\beta_\textup{control}}{2} \norm{u}^2_{L^2(0,T)}
	.
\end{equation}
Indeed, an $L^1$-norm penalty would be a more meaningful model of energy consumption.
Such a term is known to induce sparsely supported controls, see for instance \cite{VossenMaurer:2006:1,Stadler:2009:1,CasasHerzogWachsmuth:2012:2}.
In the present application, however, optimal power profiles may then require the laser to be switched off and on again.
Technical limitations require a certain amount of time before the laser can be powered up again, which is not feasible due to the brevity of usual process times~$T$ in single-spot welding.
Moreover, a waiting-time constraint would render the optimal control problem significantly more difficult.


\subsection{Optimal Control Problem Formulation}

For convenience, we summarize our single-spot welding optimal control problem as follows:

\begin{equation} \label{eq:J}
	\paren[auto].\}{%
		\begin{aligned}
			&
			\text{Find a control function $u \colon [0,T] \to \R$ which minimizes the objective}
			\\
			&
			J(u,\theta) 
			\coloneqq 
			J_\textup{penetration}(\theta) + J_\textup{velocity}(\theta) + J_\textup{completeness}(\theta) + J_\textup{control}(u)
			,
			\\
			&
			\text{where $\theta$ is the solution to the boundary value problem \eqref{eq:heat_eq}--\eqref{eq:heat_eq_bc}}
			\\
			&
			\text{and the control satisfies the constraints $0 \le u(t) \le 1$ on $[0,T]$}
			.
		\end{aligned}
	}
\end{equation}


\section{Discretization and Optimization Scheme}
\label{sec:discretization}

In this section we describe a discretization of problem \eqref{eq:J} as well as a projected gradient descent scheme for its numerical solution.
Since the discretization in space is based on a finite element approach, we begin with the notion of weak solution.
Notice that our definitions are informal since we do not aim to provide a thorough analysis of the forward system \eqref{eq:heat_eq}--\eqref{eq:heat_eq_bc} here.


\subsection{Weak Formulation}

As usual, the weak formulation is obtained by multiplying \eqref{eq:heat_eq} by a test function, integrating by parts, and plugging in the natural boundary conditions \eqref{eq:heat_eq_bc}.
Abbreviating
\begin{equation*}
	\Phi(\theta(x,t)) 
	\coloneqq 
	k \paren[big](){\theta(x,t)^4 - \theta_\textup{amb}^4} + h \paren[big](){\theta(x,t) - \theta_\textup{amb}}
	,
\end{equation*}
we thus arrive at the notion that a function $\theta \colon \Omega \times [0,T] \to \R$ is a \emph{weak solution} to the boundary value problem \eqref{eq:heat_eq}--\eqref{eq:heat_eq_bc} if it satisfies the initial condition \eqref{eq:heat_eq_ic} and the equality
\begin{multline} \label{eq:weak}
	\int_\Omega s(\theta(x,t)) \, \theta_t(x,t) \, v \d x \d t
	+
	\int_\Omega \grad \theta(x,t)^\transp \kappa(\theta(x,t)) \, \grad v \d x \d t 
	\\
	+
	\int_{\Gamma_1 \cup \Gamma_2} \Phi(\theta(x,t))\, v\d s \d t -
	\int_{\Gamma_1} \eta \, \text{pd}_{\max} \, u(t) \, v \d s \d t 
	= 
	0
\end{multline}
holds for all functions $v \in C^\infty(\Omega)$ and for almost all $t \in (0,T)$.
Recall that the thermal conductivity $\kappa(\theta)$ is a matrix due to different conductivities in radial and axial directions, see \cref{subsec:conductivity}.


\subsection{Reduction to the Radially Symmetric Case}

Up to this moment the problem was considered in $\R^3$.
However, the power density of the laser beam is taken to be radially symmetric, and there is no heat transition in $\Omega$ in the angular direction, \ie $\partial\theta/\partial\varphi = 0$. 
This motivates us to reduce the computational complexity of the problem by reducing the domain $\Omega$ to its two-dimensional radial section $\omega$, see \cref{fig:sec}.

\begin{figure}
	\centering
	\input{plots/tikz/cylinder_sec}
	\input{plots/tikz/sec}
	\caption{Draft: reduction to the radially symmetric case.}
	\label{fig:sec}
\end{figure}

From now on, we replace $\theta(x,t)$ by $\theta(r,z,t)$. 
Thus, \eqref{eq:weak} turns becomes
\begin{multline} \label{eq:weak_reduced}
	\int_\omega s(\theta(r,z,t)) \frac{\d \theta(r,z,t)}{\d t} v \, r \d r \d z \d t
	+
	\int_\omega \grad\theta(r,z,t)^\transp \kappa(\theta(r,z,t)) \grad v \, r \d r \d z \d t 
	\\
	+
	\int_{(\gamma_1 \cup \gamma_2)} \Phi(\theta(r,z,t)) \, v \, r \d s \d t -
	\int_{\gamma_1} \eta \, \text{pd}_{\max} \, u(t) \, v \, r \d s \d t 
	= 
	0
\end{multline}
for all $v \in C^\infty(\omega)$ and for almost all $t \in (0,T)$.
Notice that the gradient operator in equation~\eqref{eq:weak_reduced} must be used in its cylindrical form, \ie,
\begin{equation*}
	\grad \theta(r,z,\varphi) 
	=
	\frac{\partial \theta}{\partial r} e_r
	+
	\frac{\partial \theta}{\partial z} e_z
	+
	\frac{1}{r} \frac{\partial \theta}{\partial \varphi} e_{\varphi}
	.
\end{equation*}
However, as mentioned before, due to the radial symmetry of the heat distribution, the $e_{\varphi}$-component of $\theta$ vanishes. 
This feature is convenient for the numerical implementation, since the standard gradient operator (in Cartesian coordinate form) can be used.

Similarly, two of the penalty terms in the objective in \eqref{eq:J} are affected by the transition to cylindrical coordinates.
Specifically, \eqref{eq:J_velocity} and \eqref{eq:J_completeness} now take the following forms:
\begin{align}
	\label{eq:J_velocity_r}
	J_\textup{velocity} 
	&
	=
	\frac{\beta_\textup{velocity}}{2} \int_{\omega \times (0,T)} \max \paren[big]\{\}{\replaced[id=RH]{v(r,z,t) - v_{\max}}{v_{\max} - v(r,z,t)}, \; 0}^2 \cdot \chi(\theta(r,z,t)) \, r \d r \d z \d t
	, 
	\\
	\label{eq:J_completeness_r}
	J_\textup{completeness} 
	&
	=
	\frac{\beta_\textup{completeness}}{2} \int_{\omega} \max \paren[big]\{\}{\theta(r,z,T) - \text{solidus}, \; 0}^2 \, r \d r \d z
	.
\end{align}


\subsection{Discretization of the Forward Problem}

We now focus on discretizing the problem in time and space in order to solve it numerically. 
We combine a finite element method in space and finite difference method in time. 
The numerical implementation is based on \fenics computing platform; see \cite{LoggMardalWells:2012:1}.

Let $N_t$ be the number of equidistant time steps excluding the initial state, then we denote:
\begin{equation}
	\begin{aligned}
		&
		\tau 
		\coloneqq 
		T/N_t
		, 
		\quad
		u_n 
		\coloneqq 
		u(n\tau)
		,
		\quad
		\theta_n(r,z) 
		\coloneqq 
		\theta(r,z,n\tau)
		, 
		\\
		&
		\theta_{n+\alpha}(r,z) 
		\coloneqq 
		\alpha\theta_{n+1}(r,z) + (1-\alpha)\theta_n(r,z)
		,
	\end{aligned}
\end{equation}
where $\alpha \in [0,1]$ determines the degree of implicitness of the time scheme.

Within the time interval $(n\tau, n\tau+\tau]$, the coefficients and the operators of equation \eqref{eq:heat_eq} are discretized as follows:
\begin{equation}
	\begin{aligned}
		s(\theta(r,z,t)) 
		&
		\coloneqq 
		s(\theta_n)
		, 
		&
		\kappa(\theta(r,z,t)) 
		&
		\coloneqq 
		\kappa(\theta_n)
		, 
		&
		\Phi(\theta(r,z,t)) 
		&
		\coloneqq 
		\Phi \paren[auto](){\theta_{n+\alpha}}
		, 
		\\
		\frac{\d\theta(r,z,t)}{\d t} 
		&
		\coloneqq 
		\frac{\theta_{n+1}-\theta_n}{\tau}
		, 
		&
		\grad(\theta(r,z,t)) 
		&
		\coloneqq 
		\grad \paren[auto](){\theta_{n+\alpha}}
		.
	\end{aligned}
\end{equation}

For the discretization in space, we employ piecewise linear, globally continuous test and trial functions on a predefined mesh of $\omega$.
Now the discretized form of equation \eqref{eq:weak_reduced} reads as follows,
\begin{multline} \label{eq:discrete}
	\sum_{n=0}^{N_t-1} \int_{\omega}
	s(\theta_n) (\theta_{n+1}-\theta_n) \, v_n \, r \d r \d z
	+ \tau \sum_{n=0}^{N_t-1} \int_{\omega}
	\grad \theta_{n+\alpha}^\transp \, \kappa(\theta_n) \grad v_n \, r \d r \d z 
	\\
	+ \tau \sum_{n=0}^{N_t-1} \int_{\gamma_1 \cup \gamma_2}
	\Phi \paren[auto](){\theta_{n+\alpha}} v_n \, r \d s
	- \tau \sum_{n=0}^{N_t-1} \int_{\gamma_1}
	\eta \text{pd}_{\max} \, u_n \, v_n \, r \d s 
	= 
	0
	.
\end{multline}
In \eqref{eq:discrete} we set $\theta_0 \coloneqq \theta_\textup{amb}$.
The unknown coefficient vectors $[\theta_1, \theta_2, \ldots, \theta_{N_t}]$ at subsequent points in time is then solved time step by time step.


\subsection{Discretization of the Objective Functional}

To derive the discrete version of $J_\textup{penetration}$, we discretize \eqref{eq:J_penetration} according to
\begin{equation} \label{eq:J_penetration_discrete}
	J_\textup{penetration} 
	= 
	\frac{\beta_\textup{penetration}}{2}
	\paren[auto]\{\}{\paren[Bigg](){\added[id=RH]{\tau} \sum_{n=1}^{N_t} \abs[big]{\theta_n(0,z_\textup{target}\added[id=RH]{,n\tau})}^p}^{1/p} - \theta_\textup{target}}^2
	.
\end{equation}
\added[id=RH]{\textbf{@DS: The factor $\tau$ above may incur a change in the code.}}

The velocity of an isothermal surface (in fact an isothermal line after dimension reduction) can be approximated as
\begin{equation}
	v(\theta_n, \theta_{n+1}) 
	= 
	\frac{\added[id=RH]{{}-{}}(\theta_{n+1}-\theta_n)}{\tau \, \norm{\grad \theta_{n+\alpha}}}
\end{equation}
and hence $J_\textup{velocity}$ takes the following form:
\begin{equation}
	J_\textup{velocity} 
	=
	\frac{\beta_\textup{velocity}}{2} \tau \sum_{n=0}^{N_t-1} \int_{\omega} \max \paren[big]\{\}{ \replaced[id=RH]{v(\theta_n, \theta_{n+1}) - v_{\max}}{- v_{\max} - v(\theta_n, \theta_{n+1})}, \; 0}^2 \cdot \chi(\theta_{n+\alpha}) \, r \d r \d z
\end{equation}
\added[id=RH]{\textbf{@DS: The above corrections in the sign of $v(\theta_n,\theta_{n+1})$ may require an update of the code.}}

The remaining penalty terms $J_\textup{completeness}$ and $J_\textup{control}$ are discretized according to
\begin{align}
	J_\textup{completeness} 
	&
	=
	\frac{\beta_\textup{completeness}}{2} \int_{\omega} \max \paren[big]\{\}{\theta_{N_t} - \text{solidus}, \; 0}^2 \, r \d r \d z
	, 
	\\
	J_\textup{control} 
	&
	=
	\frac{\beta_\textup{control}}{2} \tau \sum_{n=0}^{N_t-1} u_n^2
	.
\end{align}


\subsection{Evaluation of the Gradient}

In this section we briefly describe the evaluation of the gradient by means of the discrete adjoint state $p = [p_0, p_1, \ldots, p_{N_t-1}]$.
To this end, we introduce the Lagrangian 
\begin{multline} \label{eq:lagrange}
	\cL(\theta,u,p) \coloneqq
	J(\theta,u)
	+
	\sum_{n=0}^{N_t-1}\int_{\Omega} s(\theta_n) (\theta_{n+1}-\theta_n) \, p_n \, \d x
	+ 
	\tau \sum_{n=0}^{N_t-1}\int_{\Omega} \grad \theta_{n+\alpha}^\transp \, \kappa(\theta_n) \grad p_n \d x
	\\
	+ 
	\tau \sum_{n=0}^{N_t-1}\int_{\gamma_1 \cup \gamma_2} \Phi \paren[auto](){\theta_{n+\alpha}} p_n \d s
	- 
	\tau \sum_{n=0}^{N_t-1}\int_{\gamma_1} \eta \, \text{pd}_{\max} \, u_n \, p_n \d s.
\end{multline}
The sequence of linear systems governing the discrete adjoint state is obtained from $\partial \cL(\theta,u,p)/\partial \theta_n = 0$.
We do not provide the explicit formula for the adjoint equation here since in the code we derive it using \fenics' built-in automatic differentiation capabilities.
The only manual differentiation required is for the penalty term $J_\textup{penetration}$ in \eqref{eq:J_penetration_discrete}, since it has a structure different from the other terms.
We added the contributions coming from this term manually to the adjoint state's right hand side.
\added[id=RH]{\textbf{@DS: What is different about the structure that prevents us from using AD here?}}
One can find more details in \cite[\texttt{optipuls.core}]{optipuls_github}.

Finally, we differentiate $\cL(\theta,u,p)$ with respect to $u = [u_0, u_1, \ldots, u_{N_t-1}]$ in the direction $\delta u$ to obtain
\begin{equation}
	\frac{\partial \cL(\theta,u,p)}{\partial u} \, \delta u
	=
	\tau \sum_{n=0}^{N_t-1}
	\paren[auto][]{\beta_\textup{control} \, u_n - \int_{\gamma_1} \eta \, \text{pd}_{\max} \, p_n \d s} \, \delta u
	.
\end{equation}
Consequently,
\begin{equation} \label{eq:gradient}
	\grad_u \cL(\theta, u, p) 
	= 
	\beta_\textup{control}\, u - \int_{\gamma_1} \eta \, \text{pd}_{\max} p \d s
\end{equation}
holds.


\subsection{Projected Gradient Descent Scheme}

To find the optimal control for the discretized counterpart of \eqref{eq:J}, we apply a \emph{projected gradient descent} scheme with line search; see, \eg, \cite{GafniBertsekas:1984:1,CalamaiMore:1987:1} or \cite[Chapter~5.8.2]{GeigerKanzow:2002:1}.
To this end, we denote by $j(u) = J(u,\theta)$ the reduced objective, which depends only on the values $u = [u_0, u_1, \ldots, u_{N_t-1}]$ of the control and the solution $\theta = [\theta_1, \theta_2, \ldots, \theta_{N_t}]$ to the forward system \eqref{eq:discrete} has been inserted.
Since this procedure is well known, we present only a short general outline in \cref{alg:projected_gradient_descent}.
\added[id=RH]{The norm in which the size of the gradient is evaluated is the norm represented by $\tau$ times the identity matrix.}
More details can be found in the implementation at \cite[\texttt{optipuls.optimization}]{optipuls_github}.
 
\begin{algorithm}
	\begin{algorithm}[H]
	\caption{Projected gradient descent scheme.}
	\label{alg:projected_gradient_descent}
	\DontPrintSemicolon
	\KwIn{$u_\textup{initial} \in \R^{N_t}$}
	\KwOut{$u_\textup{optimized} \in \R^{N_t}$}
	$u_\textup{current} \gets u_\textup{initial}$\;
	\While{$\norm{\grad_u j (\deleted[id=RH]{\mathcal{P}_{U}} u_\textup{current})} \ge \text{tolerance} $}{
		solve the forward system \eqref{eq:discrete} for $\theta$, given $u_\textup{current}$\;
		solve the adjoint system for $p$, given $\theta$ and $u_\textup{current}$\;
		evaluate the gradient of the reduced objective $\grad_u j(u_\textup{current})$ from \eqref{eq:gradient}\;
		\Repeat{$J(u_\textup{trial}) \ge J(u_\textup{current}) - \sigma \, \alpha \, \norm{\grad_u j (u_\textup{current})}^2$}{
			perform a line search for the step size $\alpha$\;
			$u_\textup{trial} \gets \cP_{[0,1]} \paren[auto](){u_\textup{current} - \alpha \grad_u j (u_\textup{current})}$\;
		}
		$u_\textup{current} \gets u_\textup{trial}$\;
	}
	\Return{$u_\textup{optimized} \gets u_\textup{current}$}
	\end{algorithm}
\end{algorithm}


\section{Numerical Results}
\label{sec:numericals}

\added[id=RH]{\textbf{@RH: continue revision here}}

In this section we present some optimized laser pulses, \ie, numerical solutions to the discretized counterpart of the single-spot welding optimal control problem \eqref{eq:J}.
We emphasize that all the numerical results presented in this paper are fully reproducible and hence can be verified by the reader; see \cite{optcontrol_github} for further instructions. 


\subsection{Conventional and Linear Rampdown Pulse Shapes}

Conventional laser pulse welding strategies use a rectangular laser pulse shape, \ie the laser is working full power for a short time and is switched of immediately after. 
Unfortunately, this simple strategy often leads to hot-cracking when applied to aluminum alloys.
A so-called linear rampdown pulse shape, \ie when the laser power is decreasing linearly after a short period of working full power, has shown its potential to maintain a crack-free welding of aluminum alloys; see \cite{JiaZhangYuShiLiuWuYeWangTian:2021:1}.
However, ramp-down pulses are not likely to be optimal with respect to any of the criteria established in \cref{sec:optimal_control_problem}.

In view of this we first consider the convential and the linear rampdown pulse shapes as the initial guess $u_\textup{initial}$ for the optimizer. 
\Cref{fig:rampdown} demonstrates the corresponding solutions to the optimal control problem obtained with \cref{alg:projected_gradient_descent}.
\added[id=RH]{\textbf{@DS: We need to list here all problem parameters as well as all algorithmic parameters.}}
The numerical reports on the corresponing simulations are presented in \cref{tab:rampdown}.
We observe that in both cases, we obtain apparently locally optimal pulse shapes which differ very little from their respective initial guesses.

\begin{figure} 
	\centering
	\includegraphics{plots/optimized/rampdown.pdf}
	\caption{Solutions to the optimal control problem with conventional (left) and linear rampdown (right) pulse shapes taken as initial guesses.}
	\label{fig:rampdown}
\end{figure}

\begin{table} 
	\centering
	\input{tables/rampdown}
	\caption{Results for an optimization with conventional and linear rampdown initial guesses.}
	\label{tab:rampdown}
\end{table}

\added[id=RH]{\textbf{@DS: the table headers in \cref{tab:rampdown} need to be completed and explained in the text.}}


\subsection{Optimizations from Zero Initial Guess}

In the search for obtain better pulse shapes, we now begin with the trivial initial guess $u_\textup{initial} \equiv 0$ with no power radiated by the laser. 
With this initial guess, the target temperature is clearly not reached and the term $J_\textup{penetration}$, see \eqref{eq:J_penetration_discrete}, drives the pulse shape away from its initial value.
\Cref{fig:zeroguess} shows the corresponding solutions to the optimal control problem with the vatiable maximal laser power and maximal welding time. 
The corresponding numerical reports are presented in \cref{tab:zeroguess}.
\added[id=RH]{\textbf{@DS: Here as well we need to present all problem and algorithm parameters please.}}

\begin{figure} 
	\centering
	\includegraphics{plots/optimized/zeroguess.pdf}
	\caption{Solutions to the optimal control problem with zero initial guess with the variable maximal laser power (vertical) and maximal welding time (horizontal) parameters.}
	\label{fig:zeroguess}
\end{figure}

\begin{table} 
	\centering
	\input{tables/zeroguess}
	\caption{Results of the optimization with zero initial guess (sketch)\ldots}
	\label{tab:zeroguess}
\end{table}


\subsection{Optimizations from Zero Initial Guess}

\added[id=RH]{\textbf{@DS: A discussion on optimized laser power profiles needs to be added.}}

\appendix

\section{TODO}
\begin{itemize}
	\item \cref{subsec:capacity}: introduce symbol $c(\theta)$.
	\item \cref{subsec:capacity,subsec:density,subsec:conductivity}: explain how it is technically done.
	\item \cref{subsec:equations}: organize it as a summary, putting together everything from \cref{sec:modelling}.
	\item \cref{subsec:velocity}: make a 2D picture illustrating the velocity of a single isoline at a single time moment.
	\item \cref{sec:numericals}: sketch the gradient descent algorithm.
	\item Make a short explanation about 2XXX, 5XXX, and 6XXX aluminum alloys. What is special about them and why are they relevant to this study?
	\item \cref{sec:implementation}: provide code listings with syntax highlight via pygments?
\end{itemize}
